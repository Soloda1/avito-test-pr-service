# PR Reviewer Assignment Service (Avito test)

Единый микросервис для назначения ревьюверов на Pull Request’ы, управления командами и пользователями. Взаимодействие — через HTTP API (см. `docs/openapi.yml`).

- Порт сервиса: 8080
- БД: PostgreSQL 16
- Язык: Go 1.24.2

## Содержание
- [Быстрый старт](#быстрый-старт)
- [Локальный запуск без Docker](#локальный-запуск-без-docker)
- [Конфигурация](#конфигурация)
- [Миграции](#миграции)
- [Архитектура и слои](#архитектура-и-слои)
- [Бизнес-правила](#бизнес-правила)
- [HTTP эндпоинты](#http-эндпоинты)
- [Ошибки и логирование](#ошибки-и-логирование)
- [Makefile цели](#makefile-цели)
- [Тестирование](#тестирование)
- [Проблемы/решения, с которыми столкнулись](#проблемырешения-с-которыми-столкнулись)

## Быстрый старт
Требуется Docker и docker compose.

```bash
make up         # соберёт образы, применит миграции, поднимет сервисы, прогонит тесты
make logs       # смотреть логи сервиса
make down       # остановить всё
```

Проверка здоровья:
```bash
curl http://localhost:8080/ping
# {"status":"ok"}
```

## Конфигурация
Файлы: `config/config.yml` (prod/dev) и `config/example.yml`.

Ключевые параметры:
- database: host, port, dbname, user, password
- httpServer: address, port, requestTimeout, readTimeout, writeTimeout, idleTimeout

Таймауты вынесены в конфиг: настройки применяются в сервере и middleware Timeout.

## Миграции
Каталог: `migrations/`

- 000001 — создание таблиц (актуальная схема сразу хранит идентификаторы пользователей и PR в типе TEXT)
- 000002 — индексы (ускорение JOIN/агрегаций: team_members, prs.author_id, pr_reviewers(reviewer_id, pr_id), pr_reviewers(pr_id, assigned_at))

Мигратор запускается автоматически при `docker-compose up`. Локально: `make migrate-up`/`migrate-down`.

## Архитектура и слои
- domain: модели и интерфейсы портов
- application: бизнес-логика (сервисы) поверх Unit of Work
- infrastructure:
  - persistence/postgres: репозитории (pgx + NamedArgs)
  - http: сервер, роутер (chi), middleware, handlers (эндпоинты в отдельных файлах)
  - logger: структурное логирование (slog)
  - reviewerselector: выбор ревьюверов (random)
  - migrator: применение SQL миграций

UoW (Unit of Work) — обеспечивает транзакции: Begin/Commit/Rollback и выдачу репозиториев на основе текущего tx (atomicity).

## Бизнес-правила
- При создании PR автоматически назначаются до двух активных ревьюверов из команды автора (исключая автора)
- Переназначение: заменяем ревьювера на активного из его команды (через Reassign)
- После MERGED изменять ревьюверов нельзя
- Если кандидатов меньше двух — назначаем доступное количество (0/1)
- Только активные пользователи могут быть назначены
- PR и User идентификаторы — строковые (по OpenAPI), задаются клиентом (об этом ниже в проблемах/решениях)

## HTTP эндпоинты
Полная спецификация — `docs/openapi.yml`. Основные:
- GET `/ping` — health
- POST `/team/add` — создать команду с участниками
- GET `/team/get?team_name=...` — получить команду с участниками
- POST `/users/create` — создать пользователя (ID обязателен)
- POST `/users/setIsActive` — установить флаг активности
- POST `/pullRequest/create` — создать PR (ID обязателен)
- POST `/pullRequest/merge` — пометить PR как MERGED (идемпотентно)
- POST `/pullRequest/reassign` — переназначить ревьювера
- GET `/users/getReview?user_id=...` — список PR для ревьювера (статус опционально)

## Ошибки и логирование
- Единый формат ответа об ошибке: `{ "error": { "code": string, "message": string } }`
- Маппинг HTTP-кодов в кодовые строки — `utils.HTTPStatusToCode`
- Логирование на уровне repo/service/handler (ошибки и ключевые поля: pr_id, user_id, team_id, и т.п.)

## Makefile цели
```bash
make help           # список целей
make fmt            # форматирование
make lint           # go vet
make build          # сборка сервера в bin/
make run            # запуск сервера (go run)
make migrate-up     # миграции up (go run мигратора)
make migrate-down   # миграции down
make up             # docker compose up -d --build
make down           # docker compose down
make logs           # логи сервиса
make psql           # psql к базе
make test           # тесты
make test-race      # тесты с -race
make coverage       # покрытие
make tidy           # go mod tidy
make clean          # очистка
```

## Тестирование
- Юнит-тесты для application сервисов (табличные тесткейсы)
- Интеграционные тесты реализованы для всех слоёв: репозитории, сервисы, HTTP-эндпоинты.
- Используется testcontainers-go для запуска тестовой PostgreSQL в контейнере.
- Тесты проверяют корректность бизнес-логики, работу с базой, соответствие инвариантам (например, не более двух ревьюверов, невозможность изменения после merge, корректная обработка ошибок).
- Для HTTP-эндпоинтов тесты сверяют формат и содержимое ответов, а также проверяют идемпотентность операций (например, повторный merge PR).
- Для сверки состояния используются вспомогательные методы db_helpers.go, позволяющие получать актуальное состояние из базы данных.

## Проблемы/решения, с которыми столкнулись

1) Строковые ID для PR и User (по OpenAPI)
- Проблема: изначально были UUID в БД/моделях, а по ТЗ пользователь обязан задавать ID сам (строка).
- Решение: в актуальных миграциях схема хранит `users.id`, `prs.id`, `prs.author_id`, `pr_reviewers.reviewer_id`, `pr_reviewers.pr_id` в типе `TEXT`. В коде везде перешли на `string`. Валидация на пустые строки реализована в сервисах/хендлерах.
- Последствие: Postgres ошибка `22P02` (invalid input syntax for uuid) более неактуальна для этих полей — соответствующие обработчики удалены из PR-репозитория.

2) Неполные данные PR в списках (N+1 и отсутствие ReviewerIDs)
- Проблема: `ListPRsByReviewer` изначально делал N+1 (после основной выборки вызывал загрузку ревьюверов). Возникала ошибка `conn busy` и деградация производительности.
- Решение: заменён на один агрегирующий запрос с `array_agg` по `pr_reviewers` и `HAVING reviewer_id` — теперь нет N+1 и ошибки `conn busy`.
- Индексы: добавлен `idx_pr_reviewers_pr_id_assigned_at` и другие для ускорения.

3) Обработка FK violation по именам ограничений
- Проблема: эвристика по `constraintName` хрупкая.
- Решение: используем `pgErr.TableName` (users → ErrUserNotFound, prs → ErrPRNotFound). Это надёжнее и не зависит от шаблонов имён ограничений.

4) Гонка в AddReviewer (проверка количества и вставка)
- Проблема: теоретически две конкурентные вставки могут пройти проверку и обе вставиться.
- Решение: на уровне приложения операции изменения PR выполняются в транзакции через UoW. Для сценариев, требующих строгой гарантии, используется `LockPRByID` и последовательные шаги в рамках одной tx. Дополнительно ограничение `<=2` обеспечивается инвариантами в app-слое; при необходимости можно добавить constraint/триггер.

5) Непоследовательная обработка already-exists в AddMember
- Проблема: через `ON CONFLICT DO NOTHING` было неочевидно, нужно ли возвращать ошибку при повторном добавлении.
- Решение: выбрана idempotent-семантика: повторное добавление не считается ошибкой (логируем при необходимости). Это согласовано с API.

6) Ошибка `22P02` при старой схеме
- Проблема: ранее в логах были ошибки `invalid input syntax for uuid`.
- Решение: переход на TEXT (см. п.1) + ревизия обработки 22P02 (удалена там, где неактуальна).

7) Несоответствие роутов и OpenAPI
- Проблема: эндпоинты и серверы в openapi.yml не совпадали с реальными (порт, пути).
- Решение: обновлён `docs/openapi.yml` (порт 8080, health, корректные пути), роутер приведён в соответствие.

8) Идемпотентность Merge и UpdateStatus
- Проблема: при 0 затронутых строк нужно корректно отличать «нет такого PR» и «уже MERGED».
- Решение: сделана доп. проверка «существует ли PR»; если да — трактуем как идемпотентный merge (уже MERGED).

9) Производительность и индексы
- Проблема: запросы по ревьюверам и загрузке участников требовали индексов.
- Решение: добавлены индексы (см. актуальные миграции); скорректированы запросы.

10) Поведение `/users/getReview` при несуществующем пользователе
- Текущее поведение: эндпойнт возвращает HTTP 200 и пустой список pull requests для несуществующего `user_id`. Такое поведение корректно и соответствует модели "запрос на список" — пустой список означает отсутствие назначенных PR.
---

